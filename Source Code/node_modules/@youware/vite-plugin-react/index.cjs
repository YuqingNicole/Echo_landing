"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const j=require("module"),f=require("path"),w=require("@babel/parser"),x=require("@babel/types"),h=require("fs");var b=typeof document!="undefined"?document.currentScript:null;function S(e){const n=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const o in e)if(o!=="default"){const t=Object.getOwnPropertyDescriptor(e,o);Object.defineProperty(n,o,t.get?t:{enumerable:!0,get:()=>e[o]})}}return n.default=e,Object.freeze(n)}const a=S(x);function v(e,n){const o=f.relative(process.cwd(),n),t=e.loc,u=t?`${t.start.line}:${t.start.column}`:"unknown",r=`${o}@${u}`;return Buffer.from(r,"utf8").toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}const E=j.createRequire(typeof document=="undefined"?require("url").pathToFileURL(__filename).href:b&&b.tagName.toUpperCase()==="SCRIPT"&&b.src||new URL("index.cjs",document.baseURI).href),_=E("@babel/traverse").default,C=E("@babel/generator").default,P=(e,n)=>{const o=f.basename(e);return n.some(u=>o===u)},I=()=>`;
// Visual Editor HMR Bridge - Auto-injected
if (import.meta.hot) {
  import.meta.hot.on('vite:beforeUpdate', (payload) => {
    if (window.__visualEditorCommunication) {
      window.__visualEditorCommunication.handleViteBeforeUpdate(payload);
    }
  });
  
  import.meta.hot.on('vite:afterUpdate', (payload) => {
    if (window.__visualEditorCommunication) {
      window.__visualEditorCommunication.handleViteAfterUpdate(payload);
    }
  });
}
`;function A(e){const n=e.children;if(n.length!==1)return!1;const o=n[0];return a.isJSXText(o)?o.value.trim().length>0:!1}function R(e){return!a.isJSXIdentifier(e.openingElement.name)||e.openingElement.name.name.toLowerCase()!=="img"?!1:!!e.openingElement.attributes.find(t=>a.isJSXAttribute(t)&&a.isJSXIdentifier(t.name)&&t.name.name==="src"&&a.isStringLiteral(t.value))}function M(e={}){const{include:n=["**/*.tsx","**/*.jsx"],exclude:o=["node_modules/**","**/dist/**"],entryFiles:t=["main.tsx","main.ts","main.jsx","main.js"]}=e;return{name:"visual-editor-plugin",enforce:"pre",transform(u,r){const c=P(r,t),m=c;if(!c&&!r.endsWith(".tsx")&&!r.endsWith(".jsx")||!(c||n.some(i=>r.includes(i.replace("**/","").replace("*","")))&&!o.some(i=>r.includes(i.replace("**/","").replace("*","")))))return null;try{let i=function(s,l){const d=s.openingElement.attributes;d.push(a.jsxAttribute(a.jsxIdentifier("data-yw"),a.stringLiteral(l))),A(s)&&d.push(a.jsxAttribute(a.jsxIdentifier("data-yw-t"),null)),R(s)&&d.push(a.jsxAttribute(a.jsxIdentifier("data-yw-i"),null))};const g=w.parse(u,{sourceType:"module",plugins:["jsx","typescript"],ranges:!0});let y=!1;if((!c||r.endsWith(".tsx")||r.endsWith(".jsx"))&&_(g,{JSXElement(s){const l=s.node,d=v(l,r);i(l,d),y=!0}}),m)try{const s=I(),l=w.parse(s,{sourceType:"module",plugins:["jsx","typescript"]});g.program.body.push(...l.program.body),y=!0}catch(s){console.warn(`Error injecting HMR bridge code to ${r}:`,s)}if(y){const s=C(g,{retainLines:!0,compact:!1});return{code:s.code,map:s.map}}return null}catch(i){return console.warn(`Error processing file ${r}:`,i),null}}}}function O(){return{name:"youware-manifest",buildStart(){try{const e=f.resolve(process.cwd(),"yw_manifest.json"),n=f.resolve(process.cwd(),"public","yw_manifest.json");h.existsSync(e)&&(h.mkdirSync(f.dirname(n),{recursive:!0}),h.copyFileSync(e,n))}catch(e){console.error("‚ùå [Youware Manifest] Copy yw_manifest.json failed:",e)}}}}function U(e={}){const{enableReactVisualEditor:n=!!process.env.YOUWARE_SANDBOX,enableCopyManifest:o=!0}=e,t=[];return o&&t.push(O()),n&&t.push(M(e.reactVisualEditorOptions)),{name:"youware-vite-plugin",enforce:"pre",buildStart(u){for(const r of t)r.buildStart&&typeof r.buildStart=="function"&&r.buildStart.call(this,u)},transform(u,r){let c=u,m=null;for(const p of t)if(p.transform&&typeof p.transform=="function"){const i=p.transform.call(this,c,r);i&&(typeof i=="string"?c=i:i&&typeof i=="object"&&"code"in i&&i.code&&(c=i.code,"map"in i&&(m=i.map)))}return c!==u?{code:c,map:m}:null}}}exports.youwareVitePlugin=U;
